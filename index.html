<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù†ÙˆØ± Ù„Ù„Ù†Ø¸Ø§Ø±Ø§Øª | NOOR Opticals</title>
    <style>
        /* =========================================
           1. Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ù„Ù„Ø´Ø§Ø´Ø©)
           ========================================= */
        body { font-family: 'Tahoma', 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f5f5f5; color: #333; }
        .main-container { width: 80mm; margin: 20px auto; background: #fff; padding: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); min-height: 100vh; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ù„ÙˆØ¬Ùˆ */
        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
        .logo-img { max-width: 140px; height: auto; margin-bottom: 5px; }
        .logo-text { font-size: 22px; font-weight: bold; display: block; letter-spacing: 1px; }
        .sub-logo { font-size: 14px; font-weight: bold; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
        .ticket { border: 1px solid #ddd; padding: 10px; background: #fff; }
        .info-section { font-size: 12px; border-bottom: 1px dashed #000; padding-bottom: 8px; margin-bottom: 10px; }
        .info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        
        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px; }
        th, td { border: 1px solid #000; padding: 6px; text-align: center; }
        th { background-color: #f2f2f2; font-weight: bold; }
        
        /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        select, input { width: 100%; box-sizing: border-box; font-family: inherit; font-size: 12px; border: 1px solid #ccc; padding: 3px; border-radius: 3px; font-weight: bold; }
        .price-input { width: 70px; text-align: center; }
        .total-row { border-top: 2px solid #000; padding-top: 8px; margin-top: 8px; font-weight: 900; font-size: 14px; }

        /* Ø§Ù„ØªØ°ÙŠÙŠÙ„ ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹ */
        .footer { margin-top: 15px; border-top: 1px dashed #000; padding-top: 10px; }
        .signature-area { margin-top: 35px; border-bottom: 1px solid #000; width: 100%; height: 25px; position: relative; }
        .sig-label { position: absolute; top: -20px; font-weight: bold; font-size: 12px; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„ØªØ­ÙƒÙ… */
        .controls { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; padding: 10px; background: #eee; border-radius: 5px; }
        .btn { padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 14px; transition: 0.3s; }
        .print-current-btn { background-color: #007bff; color: white; }
        .print-daily-btn { background-color: #28a745; color: white; }
        .lang-btn { background-color: #6c757d; color: white; }
        .clear-btn { background-color: #dc3545; color: white; font-size: 11px; padding: 8px; }

        /* Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø³ÙÙ„ÙŠ (Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙ‚Ø·) */
        .summary-section { margin-top: 20px; border-top: 2px solid #333; }
        .summary-table { width: 100%; font-size: 11px; }
        .summary-table th { background: #333; color: #fff; }

        /* =========================================
           2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Thermal Printer Fix)
           ========================================= */
        #print-output-container { display: none; } /* Ù…Ø®ÙÙŠ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© */

        @media print {
            /* Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø© Ù„ØªÙƒÙˆÙ† Ø±ÙˆÙ„ Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠ */
            @page { 
                size: 80mm auto; 
                margin: 0; 
            }
            
            body { 
                background: white; 
                width: 100%;
                margin: 0; 
            }

            .main-container { width: 100%; box-shadow: none; padding: 0; margin: 0; border: none; }
            
            /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
            #input-interface, .controls, .summary-section { display: none !important; }

            /* Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
            #print-output-container { display: block !important; width: 100%; padding-bottom: 20mm; /* Ù…Ø³Ø§ÙØ© Ø£Ù…Ø§Ù† Ù„Ø¢Ø®Ø± Ø§Ù„ÙˆØ±Ù‚Ø© */ }

            /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„ØªÙƒÙˆÙ† "Ù†Ø¸ÙŠÙØ©" */
            .ticket { border: none; padding: 0; margin-bottom: 10px; }
            
            /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
            table { margin: 5px 0; border: 1px solid #000; }
            th { background-color: #ddd !important; -webkit-print-color-adjust: exact; border: 1px solid #000; }
            td { border: 1px solid #000; }

            /* Ø®Ø· Ø§Ù„Ù‚Øµ Ù„Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© */
            .cut-line { 
                border-bottom: 2px dashed #000; 
                margin: 20px 0; 
                position: relative; 
                height: 10px; 
            }
            .cut-line::after { 
                content: "âœ‚"; position: absolute; left: 50%; top: -12px; transform: translateX(-50%); 
                background: #fff; padding: 0 5px; font-size: 14px; 
            }

            /* Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„ØªÙ‚Ø±ÙŠØ± */
            .grand-total-box {
                border: 3px solid #000;
                padding: 10px;
                text-align: center;
                font-size: 16px;
                font-weight: 900;
                margin-top: 20px;
                background: #eee !important; -webkit-print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>

<div class="main-container">
    
    <div id="input-interface" class="ticket">
        <div class="header">
            <span class="logo-text">NOOR Opticals</span>
            <span class="sub-logo" data-i18n="sub_logo">Ù†Ù€Ù€Ù€ÙˆØ± Ù„Ù„Ù†Ø¸Ø§Ø±Ø§Øª</span>
            <h3 data-i18n="invoice_title" style="margin-top:10px;">ÙØ§ØªÙˆØ±Ø© Ø·Ù„Ø¨ Ø¹Ø¯Ø³Ø§Øª</h3>
        </div>

        <div class="info-section">
            <div class="info-row">
                <label data-i18n="invoice_num">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</label>
                <input type="text" id="inv-num" placeholder="...">
            </div>
            <div class="info-row">
                <label data-i18n="branch">Ø§Ù„ÙØ±Ø¹:</label>
                <select id="branch-select" onchange="updateEmployees()"></select>
            </div>
            <div class="info-row">
                <span><span data-i18n="date">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <span id="current-date"></span></span>
                <span><span data-i18n="time">Ø§Ù„ÙˆÙ‚Øª:</span> <span id="current-time"></span></span>
            </div>
        </div>

        <table>
            <thead>
                <tr><th data-i18n="eye_header">Ø§Ù„Ø¹ÙŠÙ†</th><th>SPH</th><th>CYL</th></tr>
            </thead>
            <tbody>
                <tr><td data-i18n="right_eye">R (ÙŠÙ…ÙŠÙ†)</td><td><select id="r-sph" class="diopter-select"></select></td><td><select id="r-cyl" class="diopter-select"></select></td></tr>
                <tr><td data-i18n="left_eye">L (ÙŠØ³Ø§Ø±)</td><td><select id="l-sph" class="diopter-select"></select></td><td><select id="l-cyl" class="diopter-select"></select></td></tr>
            </tbody>
        </table>

        <div class="details-section">
            <div class="info-row">
                <strong data-i18n="lens_type">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¯Ø³Ø©:</strong>
                <select id="lens-type" style="width: 180px;"></select>
            </div>
            <div class="info-row">
                <strong data-i18n="lens_price">Ø³Ø¹Ø± Ø§Ù„Ø¹Ø¯Ø³Ø©:</strong>
                <input type="number" id="lens-price" class="price-input" oninput="calculateTotal()">
            </div>
            <div class="info-row">
                <strong data-i18n="install_price">Ø³Ø¹Ø± Ø§Ù„ØªØ±ÙƒÙŠØ¨:</strong>
                <input type="number" id="install-price" class="price-input" oninput="calculateTotal()">
            </div>
            <div class="info-row total-row">
                <strong data-i18n="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong>
                <input type="text" id="total-price" class="price-input" readonly>
            </div>
        </div>

        <div class="footer">
            <div class="info-row">
                <strong data-i18n="employee">Ø§Ù„Ù…ÙˆØ¸Ù:</strong>
                <select id="emp-select"></select>
            </div>
            <div class="signature-area">
                <span class="sig-label" data-i18n="signature">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn print-current-btn" onclick="printAndSave()" data-i18n="btn_print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙˆØ­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
            <div style="display: flex; gap: 5px;">
                <button class="btn print-daily-btn" style="flex:2" onclick="printDailyReport()" data-i18n="btn_report">ğŸ“‘ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ø±ÙˆÙ„ ÙƒØ§Ù…Ù„)</button>
                <button class="btn lang-btn" style="flex:1" onclick="toggleLanguage()">EN/AR</button>
            </div>
            <button class="btn clear-btn" onclick="clearArchive()" data-i18n="btn_clear">âš ï¸ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…</button>
        </div>

        <div class="summary-section">
            <h4 style="text-align: center; margin: 10px 0;">Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…: <span id="saved-count">0</span></h4>
        </div>
    </div>

    <div id="print-output-container"></div>
</div>

<script>
    // --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
    const employeesData = {
        "ar": { "Noor 1": ["Ø¹Ù…Ø±", "Ø³ÙŠØ¯", "Ù…Ù‡Ø¯ÙŠ", "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡"], "Noor 2": ["Ø²Ø¨ÙŠØ±", "ÙÙˆØ§Ø²"], "Noor 3": ["Ø²Ø¨ÙŠØ±", "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡"], "Noor 4": ["Ø³Ù‡ÙŠÙ„"] },
        "en": { "Noor 1": ["Omar", "Said", "Mahdi", "Abdullah"], "Noor 2": ["Zubair", "Fawaz"], "Noor 3": ["Zubair", "Abdullah"], "Noor 4": ["Suhail"] }
    };

    const lensOptions = {
        "ar": ["Ù…Ù„ØªÙŠ ÙƒÙˆØª (MC)", "Ø¨Ù„Ùˆ ÙƒØ§Øª (BL CUT)", "Ø¨Ù„Ùˆ ÙƒØ§Øª Ø¨Ù„Ùˆ (BL CUT BLUE)", "Ù‚Ø±ÙŠÙ† (GREEN)", "Ù‚Ø±ÙŠÙ† Ø¨Ù„Ùˆ (GREEN BLUE)", "ÙÙˆØªÙˆ Ù‚Ø±ÙŠ (PGX)", "ÙÙˆØªÙˆ Ø¨Ø±Ø§ÙˆÙ† (PGX BROWN)", "Ù‚Ø±ÙŠØ¨ / Ø¨Ø¹ÙŠØ¯ (PROGRESSIVE)", "Ø¶Ø¯ Ø§Ù„ÙƒØ³Ø± (POLY)", "Ù†ÙˆØ±Ù…Ù„ (CR39)", "Ù…Ù„ØªÙŠ ÙƒÙˆØª 1.61 (MC 1.61)", "Ù…Ù„ØªÙŠ ÙƒÙˆØª 1.67 (MC 1.67)", "ØªØ±ÙƒÙŠØ¨ Ø¥Ø·Ø§Ø± ÙƒØ§Ù…Ù„", "ØªØ±ÙƒÙŠØ¨ Ù†Øµ Ø¥Ø·Ø§Ø±", "ØªØ±ÙƒÙŠØ¨ Ø±ÙŠÙ…Ù„Ø³", "Ù†Ù‚Ù„ Ø¹Ø¯Ø³Ø§Øª Ø¥Ø·Ø§Ø± ÙƒØ§Ù…Ù„", "Ù†Ù‚Ù„ Ø¹Ø¯Ø³Ø§Øª Ù†Øµ Ø¥Ø·Ø§Ø±", "Ù†Ù‚Ù„ Ø¹Ø¯Ø³Ø§Øª Ø±ÙŠÙ…Ù„Ø³", "ØªØ±ÙƒÙŠØ¨ Ø¥Ø·Ø§Ø± ÙƒØ§Ù…Ù„ Ù…Ø¹ ØªÙ„ÙˆÙŠÙ†", "ØªØ±ÙƒÙŠØ¨ Ù†Øµ Ø¥Ø·Ø§Ø± Ù…Ø¹ ØªÙ„ÙˆÙŠÙ†", "ØªØ±ÙƒÙŠØ¨ Ø±ÙŠÙ…Ù„Ø³ Ù…Ø¹ ØªÙ„ÙˆÙŠÙ†"],
        "en": ["Multi-Coat (MC)", "BL CUT", "BL CUT BLUE", "GREEN", "GREEN BLUE", "Photo Grey (PGX)", "Photo Brown (PGX BROWN)", "PROGRESSIVE", "POLY", "CR39", "MC 1.61", "MC 1.67", "Full Frame Fitting", "Half Frame Fitting", "Rimless Fitting", "Transfer (Full Frame)", "Transfer (Half Frame)", "Transfer (Rimless)", "Full Frame + Tint", "Half Frame + Tint", "Rimless + Tint"]
    };

    const translations = {
        ar: { sub_logo: "Ù†Ù€Ù€Ù€ÙˆØ± Ù„Ù„Ù†Ø¸Ø§Ø±Ø§Øª", invoice_title: "ÙØ§ØªÙˆØ±Ø© Ø·Ù„Ø¨ Ø¹Ø¯Ø³Ø§Øª", invoice_num: "Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:", branch: "Ø§Ù„ÙØ±Ø¹:", date: "Ø§Ù„ØªØ§Ø±ÙŠØ®:", time: "Ø§Ù„ÙˆÙ‚Øª:", eye_header: "Ø§Ù„Ø¹ÙŠÙ†", right_eye: "R (ÙŠÙ…ÙŠÙ†)", left_eye: "L (ÙŠØ³Ø§Ø±)", lens_type: "Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¯Ø³Ø©:", lens_price: "Ø³Ø¹Ø± Ø§Ù„Ø¹Ø¯Ø³Ø©:", install_price: "Ø³Ø¹Ø± Ø§Ù„ØªØ±ÙƒÙŠØ¨:", total: "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:", employee: "Ø§Ù„Ù…ÙˆØ¸Ù:", signature: "Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:", btn_print: "ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙˆØ­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©", btn_report: "ğŸ“‘ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ", btn_clear: "âš ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„" },
        en: { sub_logo: "NOOR Opticals", invoice_title: "Lens Order Invoice", invoice_num: "Invoice No:", branch: "Branch:", date: "Date:", time: "Time:", eye_header: "Eye", right_eye: "R (Right)", left_eye: "L (Left)", lens_type: "Lens Type:", lens_price: "Lens Price:", install_price: "Fitting Fee:", total: "Total:", employee: "Staff:", signature: "Signature:", btn_print: "ğŸ–¨ï¸ Print & Save", btn_report: "ğŸ“‘ Daily Report", btn_clear: "âš ï¸ Clear Day" }
    };

    let currentLang = 'ar';
    let invoiceArchive = JSON.parse(localStorage.getItem('noor_db_original_style')) || [];

    // --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
    window.onload = () => {
        let opts = "";
        for (let i = 6; i >= -6; i -= 0.25) {
            let v = (i > 0 ? "+" : "") + i.toFixed(2);
            opts += `<option value="${v}" ${i===0?'selected':''}>${v}</option>`;
        }
        document.querySelectorAll('.diopter-select').forEach(s => s.innerHTML = opts);
        
        updateDropdowns();
        updateDateTime(); // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        setInterval(updateDateTime, 1000);
        
        document.getElementById('saved-count').innerText = invoiceArchive.length;
    };

    function updateDateTime() {
        const now = new Date();
        document.getElementById('current-date').innerText = now.toLocaleDateString('ar-EG');
        document.getElementById('current-time').innerText = now.toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});
    }

    function toggleLanguage() {
        // Ø­ÙØ¸ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¨Ù„ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© Ù„Ù…Ù†Ø¹ ÙÙ‚Ø¯Ø§Ù†Ù‡
        const currentBranch = document.getElementById('branch-select').value;
        
        currentLang = currentLang === 'ar' ? 'en' : 'ar';
        const t = translations[currentLang];
        document.documentElement.setAttribute('dir', currentLang === 'ar' ? 'rtl' : 'ltr');
        document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = t[el.getAttribute('data-i18n')]);
        
        updateDropdowns(); // Ù‡Ø°Ø§ ÙŠØ¹ÙŠØ¯ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…

        // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙØ±Ø¹ ÙˆØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        const branchSelect = document.getElementById('branch-select');
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Noor 1 Ø«Ø§Ø¨ØªØ© Ø¨Ø§Ù„Ù„ØºØªÙŠÙ† Ø³ÙŠØ¹Ù…Ù„)
        branchSelect.value = currentBranch;
        updateEmployees();
    }

    function updateDropdowns() {
        const branchSelect = document.getElementById('branch-select');
        // Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø±Ù…Ø´Ø© Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©ØŒ Ø£Ùˆ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©
        if(branchSelect.options.length === 0 || branchSelect.innerHTML === "") {
             branchSelect.innerHTML = ["Noor 1", "Noor 2", "Noor 3", "Noor 4"].map(b => `<option value="${b}">${b}</option>`).join('');
        }
        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø¯Ø³Ø§Øª ØªØªØºÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹
        document.getElementById('lens-type').innerHTML = lensOptions[currentLang].map(l => `<option value="${l}">${l}</option>`).join('');
        
        // Ù„Ø§ Ù†Ø³ØªØ¯Ø¹ÙŠ updateEmployees Ù‡Ù†Ø§ Ù„Ø£Ù† toggleLanguage Ø³ØªÙ‚ÙˆÙ… Ø¨Ø°Ù„Ùƒ Ø¨Ø¹Ø¯ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙØ±Ø¹
        if (document.getElementById('emp-select').options.length === 0) {
            updateEmployees();
        }
    }

    function updateEmployees() {
        const branch = document.getElementById('branch-select').value;
        document.getElementById('emp-select').innerHTML = (employeesData[currentLang][branch] || []).map(n => `<option value="${n}">${n}</option>`).join('');
    }

    function calculateTotal() {
        const lp = parseFloat(document.getElementById('lens-price').value) || 0;
        const ip = parseFloat(document.getElementById('install-price').value) || 0;
        document.getElementById('total-price').value = (lp + ip).toFixed(2);
    }

    // --- Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© ---
    function printAndSave() {
        const total = document.getElementById('total-price').value;
        if(!total || total == "0.00") return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø¹Ø±");

        const data = {
            id: Date.now(),
            inv: document.getElementById('inv-num').value || '-',
            branch: document.getElementById('branch-select').value,
            date: document.getElementById('current-date').innerText,
            time: document.getElementById('current-time').innerText,
            r_sph: document.getElementById('r-sph').value, r_cyl: document.getElementById('r-cyl').value,
            l_sph: document.getElementById('l-sph').value, l_cyl: document.getElementById('l-cyl').value,
            type: document.getElementById('lens-type').value,
            l_price: document.getElementById('lens-price').value,
            i_price: document.getElementById('install-price').value,
            total: total,
            emp: document.getElementById('emp-select').value,
            lang: currentLang
        };

        invoiceArchive.push(data);
        localStorage.setItem('noor_db_original_style', JSON.stringify(invoiceArchive));
        document.getElementById('saved-count').innerText = invoiceArchive.length;

        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø·
        generatePrintHTML([data], false);
        
        // ØªØ£Ø®ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ (500ms) Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù‚Ø¯ Ù‚Ø§Ù… Ø¨Ø±Ø³Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù‚Ø¨Ù„ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        setTimeout(() => {
            window.print();
            // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            setTimeout(() => {
                document.getElementById('inv-num').value = "";
                document.getElementById('lens-price').value = "";
                document.getElementById('install-price').value = "";
                document.getElementById('total-price').value = "";
            }, 1000);
        }, 500);
    }

    function printDailyReport() {
        if(invoiceArchive.length === 0) return alert("Ø§Ù„Ø³Ø¬Ù„ ÙØ§Ø±Øº!");
        generatePrintHTML(invoiceArchive, true);
        
        setTimeout(() => {
            window.print();
        }, 500);
    }

    function generatePrintHTML(dataList, isReport) {
        const container = document.getElementById('print-output-container');
        container.innerHTML = "";

        if(isReport) {
            container.innerHTML += `<div style="text-align:center; border:2px solid #000; padding:5px; margin-bottom:15px; font-weight:bold;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ… (${dataList.length}) ÙÙˆØ§ØªÙŠØ±</div>`;
        }

        let grandTotal = 0;

        dataList.forEach((d, index) => {
            grandTotal += parseFloat(d.total);
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„ØºØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ø£Ùˆ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙƒØ§Ø­ØªÙŠØ§Ø·
            const savedLang = d.lang || 'ar';
            const L = translations[savedLang]; 

            const html = `
            <div class="ticket" dir="${savedLang === 'ar' ? 'rtl' : 'ltr'}">
                <div class="header">
                    <span class="logo-text">NOOR Opticals</span>
                    <span class="sub-logo">${L.sub_logo}</span>
                    <h3 style="margin-top:5px; text-decoration:underline;">${L.invoice_title}</h3>
                </div>

                <div class="info-section">
                    <div class="info-row">
                        <span>${L.invoice_num}</span> <strong>${d.inv}</strong>
                    </div>
                    <div class="info-row">
                        <span>${L.branch}</span> <strong>${d.branch}</strong>
                    </div>
                    <div class="info-row">
                        <span>${d.date}</span> <span>${d.time}</span>
                    </div>
                </div>

                <table>
                    <thead><tr><th>${L.eye_header}</th><th>SPH</th><th>CYL</th></tr></thead>
                    <tbody>
                        <tr><td>R</td><td>${d.r_sph}</td><td>${d.r_cyl}</td></tr>
                        <tr><td>L</td><td>${d.l_sph}</td><td>${d.l_cyl}</td></tr>
                    </tbody>
                </table>

                <div class="details-section">
                    <div class="info-row">
                        <strong>${L.lens_type}</strong> <span>${d.type}</span>
                    </div>
                    <div class="info-row">
                        <strong>${L.lens_price}</strong> <span>${d.l_price}</span>
                    </div>
                    <div class="info-row">
                        <strong>${L.install_price}</strong> <span>${d.i_price}</span>
                    </div>
                    <div class="info-row total-row">
                        <strong>${L.total}</strong> <span>${d.total}</span>
                    </div>
                </div>

                <div class="footer">
                    <div class="info-row">
                        <strong>${L.employee}</strong> <span>${d.emp}</span>
                    </div>
                    <div class="signature-area">
                        <span class="sig-label">${L.signature}</span>
                    </div>
                </div>
            </div>
            ${isReport && index < dataList.length - 1 ? '<div class="cut-line"></div>' : ''} 
            `;
            // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ø¹Ù„Ø§Ù‡ (length - 1) ÙŠÙ…Ù†Ø¹ Ø¸Ù‡ÙˆØ± Ø®Ø· Ø§Ù„Ù‚Øµ Ø¨Ø¹Ø¯ Ø¢Ø®Ø± ÙØ§ØªÙˆØ±Ø©
            container.innerHTML += html;
        });

        if(isReport) {
            container.innerHTML += `<div class="grand-total-box">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: ${grandTotal.toFixed(2)}</div>`;
            container.innerHTML += `<br><br>`; // Ù…Ø³Ø§Ø­Ø© Ø¥Ø¶Ø§ÙÙŠØ© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù„Ø·Ø§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©
        }
    }

    function clearArchive() {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) {
            invoiceArchive = [];
            localStorage.removeItem('noor_db_original_style');
            document.getElementById('saved-count').innerText = 0;
        }
    }
</script>

</body>
</html>
